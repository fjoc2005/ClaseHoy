<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ClaseHoy</title>
    <link rel="stylesheet" href="assets/css/style.css">

    <style>
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            width: 350px;
            border-radius: 8px;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            margin-bottom: 10px;
            padding: 6px;
        }

        .modal-content button {
            padding: 8px;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="auth-container">
    <div class="auth-card">
        <h1>ClaseHoy</h1>
        <p>Profesores disponibles para reemplazos inmediatos</p>

        <div id="nav-buttons" style="margin:15px 0;"></div>
        <div id="posts-container"></div>
    </div>
</div>

<!-- 游댯 MODAL EDITAR -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Editar Aviso</h3>

        <input type="text" id="editNombre">

        <select id="editProfesion">
            <option>Lenguaje</option>
            <option>Matem치tica</option>
            <option>Historia</option>
            <option>Ciencias Naturales</option>
            <option>F칤sica</option>
            <option>Qu칤mica</option>
            <option>Biolog칤a</option>
            <option>Ingl칠s</option>
            <option>Educaci칩n F칤sica</option>
            <option>Artes</option>
            <option>M칰sica</option>
            <option>Educaci칩n Diferencial</option>
            <option>Educaci칩n Parvularia</option>
        </select>

        <input type="text" id="editRegion">
        <input type="text" id="editComuna">

        <select id="editDisponibilidad">
            <option>Disponibilidad inmediata</option>
            <option>Completando horario</option>
        </select>

        <button onclick="saveEdit()" style="background:#27ae60;color:white;">Guardar</button>
        <button onclick="closeModal()" style="background:#7f8c8d;color:white;margin-left:5px;">Cancelar</button>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-config.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const postsContainer = document.getElementById("posts-container");
    const navButtons = document.getElementById("nav-buttons");

    let currentUser = null;
    let editingPostId = null;

    firebase.auth().onAuthStateChanged(user => {
        currentUser = user;

        if (user) {
            navButtons.innerHTML = `
                <button onclick="window.location.href='post-job.html'">Publicar Aviso</button>
                <button onclick="logout()" style="margin-left:10px;">Cerrar sesi칩n</button>
            `;
        } else {
            navButtons.innerHTML = `
                <button onclick="window.location.href='login.html'">Iniciar sesi칩n</button>
                <button onclick="window.location.href='register.html'" style="margin-left:10px;">Registrarse</button>
            `;
        }
    });

    window.logout = function() {
        firebase.auth().signOut().then(() => location.reload());
    };

    window.openEdit = function(postId, post) {
        editingPostId = postId;

        document.getElementById("editNombre").value = post.nombre;
        document.getElementById("editProfesion").value = post.profesion;
        document.getElementById("editRegion").value = post.region;
        document.getElementById("editComuna").value = post.comuna;
        document.getElementById("editDisponibilidad").value = post.disponibilidad;

        document.getElementById("editModal").style.display = "flex";
    };

    window.closeModal = function() {
        document.getElementById("editModal").style.display = "none";
    };

    window.saveEdit = async function() {

        const updatedData = {
            nombre: document.getElementById("editNombre").value,
            profesion: document.getElementById("editProfesion").value,
            region: document.getElementById("editRegion").value,
            comuna: document.getElementById("editComuna").value,
            disponibilidad: document.getElementById("editDisponibilidad").value
        };

        try {
            await db.collection("posts").doc(editingPostId).update(updatedData);
            closeModal();
        } catch (error) {
            alert("Error al guardar cambios");
            console.error(error);
        }
    };

    window.deletePost = async function(postId) {
        if (!confirm("쮼liminar aviso?")) return;
        await db.collection("posts").doc(postId).delete();
    };

    function getTimeRemaining(expiresAt) {
        const diff = expiresAt.toDate() - new Date();
        if (diff <= 0) return "Expirando...";
        const hours = Math.floor(diff / (1000*60*60));
        const minutes = Math.floor((diff % (1000*60*60)) / (1000*60));
        return `Expira en: ${hours}h ${minutes}m`;
    }

    db.collection("posts")
      .where("expiresAt", ">", firebase.firestore.Timestamp.now())
      .orderBy("expiresAt")
      .onSnapshot(snapshot => {

        postsContainer.innerHTML = "";

        snapshot.forEach(doc => {

            const post = doc.data();

            const div = document.createElement("div");
            div.style.border = "1px solid #ddd";
            div.style.padding = "10px";
            div.style.marginBottom = "10px";

            div.innerHTML = `
                <h3>${post.nombre}</h3>
                <p><strong>${post.profesion}</strong></p>
                <p>${post.region} - ${post.comuna}</p>
                <p>${post.disponibilidad}</p>
                <p style="color:#c0392b;font-weight:bold;">${getTimeRemaining(post.expiresAt)}</p>
                ${currentUser ? `<p><strong>Contacto:</strong> ${post.email}</p>` : `<p style="color:gray;">Inicia sesi칩n para ver contacto</p>`}
                <div id="actions-${doc.id}"></div>
            `;

            postsContainer.appendChild(div);

            if (currentUser && currentUser.uid === post.userId) {
                document.getElementById(`actions-${doc.id}`).innerHTML = `
                    <button onclick='openEdit("${doc.id}", ${JSON.stringify(post)})' style="background:#f39c12;color:white;margin-right:5px;">Editar</button>
                    <button onclick='deletePost("${doc.id}")' style="background:#e74c3c;color:white;">Eliminar</button>
                `;
            }

        });

    });

});
</script>

</body>
</html>
