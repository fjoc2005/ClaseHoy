<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ClaseHoy</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="auth-container">
    <div class="auth-card">
        <h1>ClaseHoy</h1>
        <p>Profesores disponibles para reemplazos inmediatos</p>

        <div id="nav-buttons" style="margin:15px 0;"></div>

        <!--  FILTROS -->
        <div style="margin-bottom:20px;">
            <select id="filter-region">
                <option value="">Todas las regiones</option>
            </select>

            <select id="filter-disponibilidad" style="margin-left:10px;">
                <option value="">Todas las disponibilidades</option>
                <option value="Inmediata">Disponibilidad inmediata</option>
                <option value="Completando horario">Completando horario</option>
            </select>
        </div>

        <div id="posts-container"></div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-config.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const postsContainer = document.getElementById("posts-container");
    const navButtons = document.getElementById("nav-buttons");
    const filterRegion = document.getElementById("filter-region");
    const filterDisponibilidad = document.getElementById("filter-disponibilidad");

    let allPosts = [];

    //  Mostrar botones seg煤n sesi贸n
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            navButtons.innerHTML = `
                <button onclick="window.location.href='post-job.html'">
                    Publicar Aviso
                </button>
                <button onclick="logout()" style="margin-left:10px;">
                    Cerrar sesi贸n
                </button>
            `;
        } else {
            navButtons.innerHTML = `
                <button onclick="window.location.href='login.html'">
                    Iniciar sesi贸n
                </button>
                <button onclick="window.location.href='register.html'" style="margin-left:10px;">
                    Registrarse
                </button>
            `;
        }
    });

    window.logout = function() {
        firebase.auth().signOut().then(() => {
            window.location.reload();
        });
    };

    //  Funci贸n contador
    function getTimeRemaining(expiresAt) {
        const now = new Date();
        const expireDate = expiresAt.toDate();
        const diff = expireDate - now;

        if (diff <= 0) return "Expirando...";

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        return `Expira en: ${hours}h ${minutes}m`;
    }

    //  Renderizar avisos
    function renderPosts() {

        postsContainer.innerHTML = "";

        const selectedRegion = filterRegion.value;
        const selectedDisponibilidad = filterDisponibilidad.value;

        const filtered = allPosts.filter(post => {
            const regionMatch = selectedRegion === "" || post.region === selectedRegion;
            const disponibilidadMatch = selectedDisponibilidad === "" || post.disponibilidad === selectedDisponibilidad;
            return regionMatch && disponibilidadMatch;
        });

        if (filtered.length === 0) {
            postsContainer.innerHTML = "<p>No hay avisos con esos filtros.</p>";
            return;
        }

        filtered.forEach(post => {

            const postDiv = document.createElement("div");

            postDiv.innerHTML = `
                <h3>${post.nombre}</h3>
                <p><strong>${post.profesion}</strong></p>
                <p>${post.region} - ${post.comuna}</p>
                <p>${post.disponibilidad}</p>
                <p id="timer-${post.id}"></p>
                <div id="contact-${post.id}"></div>
            `;

            postsContainer.appendChild(postDiv);

            function updateTimer() {
                const timerElement = document.getElementById(`timer-${post.id}`);
                if (timerElement) {
                    timerElement.innerText = getTimeRemaining(post.expiresAt);
                }
            }

            updateTimer();
            setInterval(updateTimer, 60000);

            firebase.auth().onAuthStateChanged(user => {
                const contactDiv = document.getElementById(`contact-${post.id}`);

                if (user) {
                    contactDiv.innerHTML = `
                        <p><strong>Contacto:</strong> ${post.email}</p>
                    `;
                } else {
                    contactDiv.innerHTML = `
                        <p style="color:gray;">Inicia sesi贸n para ver el contacto</p>
                    `;
                }
            });

        });
    }

    //  Cargar avisos
    db.collection("posts")
      .where("expiresAt", ">", firebase.firestore.Timestamp.now())
      .orderBy("expiresAt")
      .onSnapshot(snapshot => {

        allPosts = [];
        const regionsSet = new Set();

        snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id;
            allPosts.push(data);
            regionsSet.add(data.region);
        });

        // Cargar regiones 煤nicas en el filtro
        filterRegion.innerHTML = `<option value="">Todas las regiones</option>`;
        regionsSet.forEach(region => {
            filterRegion.innerHTML += `<option value="${region}">${region}</option>`;
        });

        renderPosts();
    });

    filterRegion.addEventListener("change", renderPosts);
    filterDisponibilidad.addEventListener("change", renderPosts);

});
</script>

</body>
</html>
