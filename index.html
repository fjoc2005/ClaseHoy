<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ClaseHoy</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="auth-container">
    <div class="auth-card">
        <h1>ClaseHoy</h1>
        <p>Profesores disponibles para reemplazos inmediatos</p>

        <div id="nav-buttons" style="margin:15px 0;"></div>

        <!-- üîé FILTROS -->
        <div style="margin-bottom:20px; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <select id="filter-region">
                <option value="">Todas las regiones</option>
            </select>

            <select id="filter-comuna" disabled>
                <option value="">Todas las comunas</option>
            </select>

            <select id="filter-disponibilidad" style="margin-left:10px;">
                <option value="">Todas las disponibilidades</option>
                <option value="Inmediata">Disponibilidad inmediata</option>
                <option value="Completando horario">Completando horario</option>
            </select>
        </div>

        <div id="posts-container"></div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-config.js"></script>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üåé Datos de Regiones y Comunas de Chile (extra√≠dos del dataset oficial)
// Puedes ampliar o actualizar esto en assets/js/chile-data.js si quieres reusarlo
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ChileanRegions = [
    {"region":"Regi√≥n de Arica y Parinacota","comunas":["Arica","Camarones","Putre","General Lagos"]},
    {"region":"Regi√≥n de Tarapac√°","comunas":["Iquique","Alto Hospicio","Pozo Almonte","Cami√±a","Colchane","Huara","Pica"]},
    {"region":"Regi√≥n de Antofagasta","comunas":["Antofagasta","Mejillones","Sierra Gorda","Taltal","Calama","Ollag√ºe","San Pedro de Atacama","Tocopilla","Mar√≠a Elena"]},
    {"region":"Regi√≥n de Atacama","comunas":["Copiap√≥","Caldera","Tierra Amarilla","Cha√±aral","Diego de Almagro","Vallenar","Alto del Carmen","Freirina","Huasco"]},
    {"region":"Regi√≥n de Coquimbo","comunas":["La Serena","Coquimbo","Andacollo","La Higuera","Vicu√±a","Illapel","Canela","Los Vilos","Salamanca","Ovalle","Combarbal√°","Punitaqui","R√≠o Hurtado"]},
    {"region":"Regi√≥n de Valpara√≠so","comunas":["Valpara√≠so","Casablanca","Conc√≥n","Juan Fern√°ndez","Puchuncav√≠","Quintero","Vi√±a del Mar","Isla de Pascua","Los Andes","Calle Larga","Rinconada","San Esteban","La Ligua","Cabildo","Papudo","Petorca","Zapallar","Quillota","Calera","Hijuelas","La Cruz","Nogales","San Antonio","Algarrobo","Cartagena","El Tabo","El Quisco","Santo Domingo","San Felipe","Catemu","Llaillay","Panquehue","Putaendo","Santa Mar√≠a"]},
    {"region":"Regi√≥n Metropolitana de Santiago","comunas":["Cerrillos","Cerro Navia","Conchal√≠","El Bosque","Estaci√≥n Central","Huechuraba","Independencia","La Cisterna","La Florida","La Granja","La Pintana","La Reina","Las Condes","Lo Barnechea","Lo Espejo","Lo Prado","Macul","Maip√∫","√ëu√±oa","Pedro Aguirre Cerda","Pe√±alol√©n","Providencia","Pudahuel","Quilicura","Quinta Normal","Recoleta","Renca","San Joaqu√≠n","San Miguel","San Ram√≥n","Santiago","Vitacura"]},
    {"region":"Regi√≥n del Libertador General Bernardo O‚ÄôHiggins","comunas":["Rancagua","Codegua","Coinco","Coltauco","Do√±ihue","Graneros","Las Cabras","Machal√≠","Malloa","Mostazal","Olivar","Peumo","Pichidegua","Quinta de Tilcoco","Rengo","Requ√≠noa","San Vicente","Pichilemu","La Estrella","Litueche","Marchihue","Navidad","Peredones"]},
    {"region":"Regi√≥n del Maule","comunas":["Talca","Cauquenes","Chanco","Constituci√≥n","Curic√≥","Empedrado","Huala√±√©","Licant√©n","Maule","Pelarco","Pencahue","R√≠o Claro","San Clemente","San Rafael","Cauquenes"]},
    {"region":"Regi√≥n de √ëuble","comunas":["Chill√°n","Chill√°n Viejo","Bulnes","Cobquecura","Coelemu","El Carmen","Ninhue","Portezuelo","Quill√≥n","R√°nquil","San Carlos","San Fabi√°n","San Ignacio","Treguaco","Yungay"]},
    {"region":"Regi√≥n del Biob√≠o","comunas":["Concepci√≥n","Coronel","Chiguayante","Florida","Hualp√©n","Hualqui","Lota","Penco","San Pedro de la Paz","Santa Juana","Talcahuano","Tom√©","Yumbel","Antuco","Ca√±ete","Los √Ålamos","Lebu","Arauco","Curanilahue","Tir√∫a"]},
    {"region":"Regi√≥n de La Araucan√≠a","comunas":["Temuco","Carahue","Cunco","Curarrehue","Freire","Galvarino","Gorbea","Lautaro","Loncoche","Melipeuco","Nueva Imperial","Padre Las Casas","Pitrufqu√©n","Puc√≥n","Saavedra","Teodoro Schmidt","Tolt√©n","Villarrica"]},
    {"region":"Regi√≥n de Los R√≠os","comunas":["Valdivia","Corral","Lanco","Los Lagos","Mariquina","Paillaco","Panguipulli"]},
    {"region":"Regi√≥n de Los Lagos","comunas":["Puerto Montt","Castro","Ancud","Osorno","Quell√≥n","Calbuco","Chait√©n","Fresia","Frutillar","Llanquihue","Maull√≠n","Osorno","Palena"]},
    {"region":"Regi√≥n de Ays√©n del General Carlos Ib√°√±ez del Campo","comunas":["Coihaique","Ais√©n","Cisnes","Guaitecas","Chile Chico","O‚ÄôHiggins"]},
    {"region":"Regi√≥n de Magallanes y de la Ant√°rtica Chilena","comunas":["Punta Arenas","Puerto Natales","Porvenir","Timaukel","Cabo de Hornos"]}
];

document.addEventListener("DOMContentLoaded", () => {
    const postsContainer = document.getElementById("posts-container");
    const navButtons = document.getElementById("nav-buttons");
    const filterRegion = document.getElementById("filter-region");
    const filterComuna = document.getElementById("filter-comuna");
    const filterDisponibilidad = document.getElementById("filter-disponibilidad");

    let allPosts = [];

    // ‚îÄ‚îÄ POBLAR SELECTS DE REGIONES/COMUNAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ChileanRegions.forEach(reg => {
        filterRegion.innerHTML += `<option value="${reg.region}">${reg.region}</option>`;
    });

    filterRegion.addEventListener("change", () => {
        filterComuna.innerHTML = `<option value="">Todas las comunas</option>`;
        filterComuna.disabled = false;

        const region = filterRegion.value;
        const regionData = ChileanRegions.find(r => r.region === region);

        if (regionData) {
            regionData.comunas.forEach(c => {
                filterComuna.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }
        renderPosts();
    });

    filterComuna.addEventListener("change", renderPosts);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // El resto del c√≥digo (botones, firestore y renderizado) queda igual
    // pero dentro de las funciones renderPosts y onSnapshot
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Mostrar sesi√≥n
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            navButtons.innerHTML = `
                <button onclick="window.location.href='post-job.html'">Publicar Aviso</button>
                <button onclick="logout()" style="margin-left:10px;">Cerrar sesi√≥n</button>
            `;
        } else {
            navButtons.innerHTML = `
                <button onclick="window.location.href='login.html'">Iniciar sesi√≥n</button>
                <button onclick="window.location.href='register.html'" style="margin-left:10px;">Registrarse</button>
            `;
        }
    });

    window.logout = function() {
        firebase.auth().signOut().then(() => {
            window.location.reload();
        });
    };

    function getTimeRemaining(expiresAt) {
        const now = new Date();
        const expireDate = expiresAt.toDate();
        const diff = expireDate - now;
        if (diff <= 0) return "Expirando...";
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        return `Expira en: ${hours}h ${minutes}m`;
    }

    function renderPosts() {
        postsContainer.innerHTML = "";

        const selectedRegion = filterRegion.value;
        const selectedComuna = filterComuna.value;
        const selectedDisp = filterDisponibilidad.value;

        const filtered = allPosts.filter(post => {
            const regionMatch = selectedRegion === "" || post.region === selectedRegion;
            const comunaMatch = selectedComuna === "" || post.comuna === selectedComuna;
            const dispMatch = selectedDisp === "" || post.disponibilidad === selectedDisp;
            return regionMatch && comunaMatch && dispMatch;
        });

        if (filtered.length === 0) {
            postsContainer.innerHTML = "<p>No hay avisos con esos filtros.</p>";
            return;
        }

        filtered.forEach(post => {
            const postDiv = document.createElement("div");
            postDiv.innerHTML = `
                <h3>${post.nombre}</h3>
                <p><strong>${post.profesion}</strong></p>
                <p>${post.region} - ${post.comuna}</p>
                <p>${post.disponibilidad}</p>
                <p id="timer-${post.id}"></p>
                <div id="contact-${post.id}"></div>
            `;
            postsContainer.appendChild(postDiv);

            function updateTimer() {
                const timerElement = document.getElementById(`timer-${post.id}`);
                if (timerElement) {
                    timerElement.innerText = getTimeRemaining(post.expiresAt);
                }
            }
            updateTimer();
            setInterval(updateTimer, 60000);

            firebase.auth().onAuthStateChanged(user => {
                const contactDiv = document.getElementById(`contact-${post.id}`);
                if (user) {
                    contactDiv.innerHTML = `<p><strong>Contacto:</strong> ${post.email}</p>`;
                } else {
                    contactDiv.innerHTML = `<p style="color:gray;">Inicia sesi√≥n para ver el contacto</p>`;
                }
            });
        });
    }

    db.collection("posts")
      .where("expiresAt", ">", firebase.firestore.Timestamp.now())
      .orderBy("expiresAt")
      .onSnapshot(snapshot => {
        allPosts = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id;
            allPosts.push(data);
        });
        renderPosts();
    });

});
</script>

</body>
</html>
