<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ClaseHoy</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="auth-container">
    <div class="auth-card">
        <h1>ClaseHoy</h1>
        <p>Profesores disponibles para reemplazos inmediatos</p>

        <div id="nav-buttons" style="margin:15px 0;"></div>

        <br>

        <div id="posts-container"></div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-config.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const postsContainer = document.getElementById("posts-container");
    const navButtons = document.getElementById("nav-buttons");

    let currentUser = null;

    firebase.auth().onAuthStateChanged(user => {

        currentUser = user;

        if (user) {
            navButtons.innerHTML = `
                <button onclick="window.location.href='post-job.html'">
                    Publicar Aviso
                </button>
                <button onclick="logout()" style="margin-left:10px;">
                    Cerrar sesi贸n
                </button>
            `;
        } else {
            navButtons.innerHTML = `
                <button onclick="window.location.href='login.html'">
                    Iniciar sesi贸n
                </button>
                <button onclick="window.location.href='register.html'" style="margin-left:10px;">
                    Registrarse
                </button>
            `;
        }

    });

    window.logout = function() {
        firebase.auth().signOut().then(() => {
            window.location.reload();
        });
    };

    //  ELIMINAR
    window.deletePost = async function(postId) {
        if (!confirm("驴Seguro que deseas eliminar tu aviso?")) return;

        try {
            await db.collection("posts").doc(postId).delete();
        } catch (error) {
            alert("Error al eliminar aviso.");
            console.error(error);
        }
    };

    //  EDITAR
    window.editPost = async function(postId, postData) {

        const nuevoNombre = prompt("Editar nombre:", postData.nombre);
        if (!nuevoNombre) return;

        const nuevaProfesion = prompt("Editar profesi贸n:", postData.profesion);
        if (!nuevaProfesion) return;

        const nuevaRegion = prompt("Editar regi贸n:", postData.region);
        if (!nuevaRegion) return;

        const nuevaComuna = prompt("Editar comuna:", postData.comuna);
        if (!nuevaComuna) return;

        const nuevaDisponibilidad = prompt("Editar disponibilidad:", postData.disponibilidad);
        if (!nuevaDisponibilidad) return;

        try {
            await db.collection("posts").doc(postId).update({
                nombre: nuevoNombre,
                profesion: nuevaProfesion,
                region: nuevaRegion,
                comuna: nuevaComuna,
                disponibilidad: nuevaDisponibilidad
            });
        } catch (error) {
            alert("Error al editar aviso.");
            console.error(error);
        }
    };

    function getTimeRemaining(expiresAt) {
        const now = new Date();
        const expireDate = expiresAt.toDate();
        const diff = expireDate - now;

        if (diff <= 0) return "Expirando...";

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        return `Expira en: ${hours}h ${minutes}m`;
    }

    db.collection("posts")
      .where("expiresAt", ">", firebase.firestore.Timestamp.now())
      .orderBy("expiresAt")
      .onSnapshot(snapshot => {

        postsContainer.innerHTML = "";

        if (snapshot.empty) {
            postsContainer.innerHTML = "<p>No hay avisos activos.</p>";
            return;
        }

        snapshot.forEach(doc => {

            const post = doc.data();

            const postDiv = document.createElement("div");
            postDiv.style.border = "1px solid #ddd";
            postDiv.style.padding = "10px";
            postDiv.style.marginBottom = "10px";

            postDiv.innerHTML = `
                <h3>${post.nombre}</h3>
                <p><strong>${post.profesion}</strong></p>
                <p>${post.region} - ${post.comuna}</p>
                <p>${post.disponibilidad}</p>
                <p id="timer-${doc.id}" style="color:#c0392b; font-weight:bold;"></p>
                <div id="contact-${doc.id}"></div>
                <div id="actions-${doc.id}" style="margin-top:10px;"></div>
            `;

            postsContainer.appendChild(postDiv);

            function updateTimer() {
                const timerElement = document.getElementById(`timer-${doc.id}`);
                if (timerElement) {
                    timerElement.innerText = getTimeRemaining(post.expiresAt);
                }
            }

            updateTimer();
            setInterval(updateTimer, 60000);

            const contactDiv = document.getElementById(`contact-${doc.id}`);
            if (currentUser) {
                contactDiv.innerHTML = `
                    <p><strong>Contacto:</strong> ${post.email}</p>
                `;
            } else {
                contactDiv.innerHTML = `
                    <p style="color:gray;">Inicia sesi贸n para ver el contacto</p>
                `;
            }

            const actionsDiv = document.getElementById(`actions-${doc.id}`);
            if (currentUser && currentUser.uid === post.userId) {
                actionsDiv.innerHTML = `
                    <button onclick='editPost("${doc.id}", ${JSON.stringify(post)})'
                        style="margin-right:10px; background:#f39c12; color:white;">
                        Editar
                    </button>
                    <button onclick='deletePost("${doc.id}")'
                        style="background:#e74c3c; color:white;">
                        Eliminar
                    </button>
                `;
            }

        });

    });

});
</script>

</body>
</html>
