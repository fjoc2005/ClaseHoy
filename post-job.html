<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Publicar Aviso - ClaseHoy</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="auth-container">
    <div class="auth-card">
        <h2>Publicar Aviso de Disponibilidad</h2>

        <div id="message" style="margin-bottom:10px;"></div>

        <form id="post-form">
            <input type="text" name="profesion" placeholder="Profesión (Ej: Profesor de Matemática)" required>

            <input type="text" name="region" placeholder="Región" required>

            <input type="text" name="comuna" placeholder="Comuna" required>

            <select name="disponibilidad" required>
                <option value="">Seleccionar disponibilidad</option>
                <option value="Inmediata">Disponibilidad inmediata</option>
                <option value="Completando horario">Completando horario</option>
            </select>

            <button type="submit">Publicar Aviso (24 horas)</button>
        </form>

        <br>
        <button id="logout-btn">Cerrar sesión</button>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="assets/js/firebase-config.js"></script>
<script src="assets/js/auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

    const user = firebase.auth().currentUser;

    firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
            window.location.href = "login.html";
        }
    });

    const form = document.getElementById("post-form");
    const messageDiv = document.getElementById("message");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const currentUser = firebase.auth().currentUser;

        if (!currentUser) {
            window.location.href = "login.html";
            return;
        }

        messageDiv.innerHTML = "Publicando...";

        const formData = new FormData(form);

        const profesion = formData.get("profesion");
        const region = formData.get("region");
        const comuna = formData.get("comuna");
        const disponibilidad = formData.get("disponibilidad");

        const now = firebase.firestore.Timestamp.now();
        const expiresAt = new firebase.firestore.Timestamp(
            now.seconds + (24 * 60 * 60),
            now.nanoseconds
        );

        try {

            // Eliminar aviso anterior del usuario
            const existing = await db.collection("posts")
                .where("userId", "==", currentUser.uid)
                .get();

            existing.forEach(doc => {
                doc.ref.delete();
            });

            // Obtener nombre del usuario
            const userDoc = await db.collection("users").doc(currentUser.uid).get();
            const nombre = userDoc.data().nombre;

            // Crear nuevo aviso
            await db.collection("posts").add({
                nombre: nombre,
                profesion: profesion,
                region: region,
                comuna: comuna,
                disponibilidad: disponibilidad,
                email: currentUser.email,
                userId: currentUser.uid,
                createdAt: now,
                expiresAt: expiresAt
            });

            messageDiv.innerHTML = "✅ Aviso publicado correctamente (activo 24 horas)";
            form.reset();

        } catch (error) {
            console.error(error);
            messageDiv.innerHTML = "❌ Error al publicar aviso";
        }
    });

    document.getElementById("logout-btn").addEventListener("click", async () => {
        await firebase.auth().signOut();
        window.location.href = "index.html";
    });

});
</script>

</body>
</html>
